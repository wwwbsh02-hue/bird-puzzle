<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¦ ë²„ë“œ ì†ŒíŠ¸ í¼ì¦ ğŸ¦</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="1920" height="1080"><defs><linearGradient id="sky" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:%2387CEEB"/><stop offset="50%" style="stop-color:%23B0E0E6"/><stop offset="100%" style="stop-color:%2398FB98"/></linearGradient></defs><rect width="1920" height="1080" fill="url(%23sky)"/><ellipse cx="200" cy="150" rx="80" ry="40" fill="white" opacity="0.7"/><ellipse cx="1600" cy="200" rx="100" ry="50" fill="white" opacity="0.6"/><ellipse cx="800" cy="100" rx="90" ry="45" fill="white" opacity="0.65"/><circle cx="1700" cy="150" r="60" fill="%23FFE4B5" opacity="0.8"/></svg>') center/cover fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1100px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
        }

        h1 {
            color: #5B4FC7;
            font-size: 2.8em;
            margin-bottom: 15px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.2);
            font-weight: bold;
        }

        .world-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .world-btn {
            padding: 12px 25px;
            border: 3px solid #667eea;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .world-btn:hover {
            background: #f0f0ff;
            transform: translateY(-2px);
        }

        .world-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .world-btn.add-world {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border-color: #4CAF50;
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .info-item {
            font-size: 1.3em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-item span {
            background: rgba(255,255,255,0.3);
            padding: 5px 15px;
            border-radius: 10px;
            min-width: 50px;
            text-align: center;
        }

        .level-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .level-nav-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .level-nav-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.5);
            transform: scale(1.1);
        }

        .level-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* ì—ë””í„° ë‚´ë¶€ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ */
        .modal-content .level-nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .modal-content .level-nav-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #7d8ff0 0%, #8b5bb0 100%);
            transform: scale(1.1);
        }

        .modal-content .level-nav-btn:disabled {
            background: #ccc;
            opacity: 0.5;
        }

        .game-area {
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 100%);
            border-radius: 20px;
            padding: 30px 20px;
            margin-bottom: 25px;
            min-height: 450px;
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .game-area::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(180deg, transparent 0%, #90EE90 100%);
            pointer-events: none;
        }

        .tubes-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
            position: relative;
            z-index: 10;
        }

        .tube-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .tube-wrapper:hover:not(.disabled) {
            transform: translateY(-8px);
        }

        .tube-wrapper.selected {
            transform: translateY(-12px) scale(1.05);
        }

        .tube-wrapper.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tube {
            width: 70px;
            height: 280px;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.6) 100%);
            border: 4px solid #8B7355;
            border-radius: 15px 15px 20px 20px;
            padding: 8px;
            display: flex;
            flex-direction: column-reverse;
            gap: 4px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            position: relative;
        }

        .tube-wrapper.selected .tube {
            border-color: #FFD700;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), 0 8px 20px rgba(0,0,0,0.3);
            background: linear-gradient(180deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.8) 100%);
        }

        .tube::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.3) 0%, 
                transparent 20%, 
                transparent 80%, 
                rgba(0,0,0,0.1) 100%);
            border-radius: 11px 11px 16px 16px;
            pointer-events: none;
        }

        .bird-in-tube {
            height: 62px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        .bird-in-tube.pop-in {
            animation: birdPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .bird-in-tube.moving {
            opacity: 0;
            transform: scale(0.5) translateY(-20px);
        }

        @keyframes birdPop {
            0% {
                transform: scale(0) translateY(20px);
                opacity: 0;
            }
            70% {
                transform: scale(1.1) translateY(-5px);
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .bird-svg {
            width: 55px;
            height: 55px;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.4));
        }

        .buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 16px 32px;
            font-size: 1.15em;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(-1px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-undo {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .btn-restart {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: white;
        }

        .btn-hint {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }

        .btn-edit {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.75);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #fff 0%, #f8f9ff 100%);
            padding: 40px;
            border-radius: 30px;
            animation: modalBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 25px 70px rgba(0,0,0,0.5);
            border: 5px solid #667eea;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalBounce {
            0% {
                transform: scale(0.3) rotate(-5deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.05) rotate(2deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .modal h2 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 25px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .modal p {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .editor-section {
            margin-bottom: 25px;
        }

        .editor-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .editor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-weight: bold;
            color: #333;
        }

        .input-group input,
        .input-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .color-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .color-item:hover {
            border-color: #667eea;
        }

        .color-preview {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #333;
            cursor: pointer;
        }

        .tube-editor {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .editor-tube {
            width: 70px;
            height: 280px;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.6) 100%);
            border: 4px solid #8B7355;
            border-radius: 15px 15px 20px 20px;
            padding: 8px;
            display: flex;
            flex-direction: column-reverse;
            gap: 4px;
            position: relative;
        }

        .editor-bird-slot {
            height: 62px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .editor-bird-slot:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
        }

        .editor-bird-slot img {
            width: 55px;
            height: 55px;
        }

        .editor-bird-slot .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .editor-bird-slot:hover .remove-btn {
            display: flex;
        }

        .color-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: bold;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
            margin-bottom: 8px;
        }

        .color-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }

        .editor-bird-slot:hover .color-tooltip {
            opacity: 1;
        }

        .tube-controls {
            text-align: center;
            margin-top: 10px;
        }

        .tube-controls button {
            padding: 8px 16px;
            font-size: 0.9em;
            margin: 0 5px;
        }

        .status-msg {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.25em;
            min-height: 40px;
            color: #667eea;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .branch-base {
            width: 85px;
            height: 15px;
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            border-radius: 50%;
            margin-top: 5px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn-save {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-cancel {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
            color: white;
        }

        .world-info {
            background: #f0f0ff;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .world-info h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .delete-world-btn {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
            color: white;
            padding: 8px 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>ğŸ¦ ë²„ë“œ ì†ŒíŠ¸ í¼ì¦ ğŸ¦</h1>
        </div>

        <div class="world-selector" id="worldSelector"></div>

        <div class="info-bar">
            <div class="level-controls">
                <button class="level-nav-btn" id="prevLevelBtn" onclick="previousLevel()">â—€</button>
                <div class="info-item">
                    ğŸ“Š ë ˆë²¨ <span id="level">1</span>
                </div>
                <button class="level-nav-btn" id="nextLevelBtn" onclick="nextLevel()">â–¶</button>
            </div>
            <div class="info-item">
                ğŸ¯ ì´ë™ <span id="moves">0</span>
            </div>
        </div>

        <div class="status-msg" id="statusMsg"></div>

        <div class="game-area">
            <div class="tubes-container" id="tubesContainer"></div>
        </div>

        <div class="buttons">
            <button class="btn-undo" onclick="undoMove()" id="undoBtn">
                <span>â†©ï¸</span> ë˜ëŒë¦¬ê¸°
            </button>
            <button class="btn-restart" onclick="restartLevel()">
                <span>ğŸ”„</span> ë‹¤ì‹œ ì‹œì‘
            </button>
            <button class="btn-hint" onclick="showHint()" id="hintBtn">
                <span>ğŸ’¡</span> íŒíŠ¸
            </button>
            <button class="btn-edit" onclick="openLevelEditor()" id="editBtn">
                <span>âœï¸</span> ë ˆë²¨ í¸ì§‘
            </button>
        </div>
    </div>

    <!-- ìŠ¹ë¦¬ ëª¨ë‹¬ -->
    <div class="modal" id="winModal">
        <div class="modal-content" style="text-align: center;">
            <div style="font-size: 3em; margin-bottom: 20px;">â­â­â­</div>
            <h2>ğŸ‰ ë ˆë²¨ í´ë¦¬ì–´! ğŸ‰</h2>
            <p>ì¶•í•˜í•©ë‹ˆë‹¤!</p>
            <p style="font-size: 1.6em; color: #667eea; font-weight: bold;">
                ì´ë™ íšŸìˆ˜: <span id="finalMoves">0</span>íšŒ
            </p>
            <div class="modal-buttons">
                <button class="btn-restart" onclick="restartLevel(); closeModal('winModal')">
                    ğŸ”„ ë‹¤ì‹œ ë„ì „
                </button>
                <button class="btn-save" onclick="nextLevel(); closeModal('winModal')" style="font-size: 1.2em; padding: 20px 40px;">
                    ë‹¤ìŒ ë ˆë²¨ â¡ï¸
                </button>
            </div>
        </div>
    </div>

    <!-- ë ˆë²¨ ì—ë””í„° ëª¨ë‹¬ -->
    <div class="modal" id="editorModal">
        <div class="modal-content" style="max-width: 1000px;">
            <h2>âœï¸ ë ˆë²¨ ì—ë””í„°</h2>
            
            <div class="world-info" id="editorWorldInfo"></div>

            <div class="editor-section">
                <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <button class="level-nav-btn" id="editorPrevBtn" onclick="editorPreviousLevel()" style="position: static; width: 45px; height: 45px; font-size: 1.5em;">â—€</button>
                    <div style="text-align: center;">
                        <div style="font-size: 1.3em; font-weight: bold; color: #667eea;">ë ˆë²¨ <span id="editorLevelNum">1</span></div>
                        <div style="font-size: 0.9em; color: #666;">ì´ <span id="editorTotalLevels">1</span>ê°œ ë ˆë²¨</div>
                    </div>
                    <button class="level-nav-btn" id="editorNextBtn" onclick="editorNextLevel()" style="position: static; width: 45px; height: 45px; font-size: 1.5em;">â–¶</button>
                </div>
                <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
                    <button class="btn-save" onclick="addNewLevel()" style="padding: 12px 25px; font-size: 1em;">
                        â• ìƒˆ ë ˆë²¨ ì¶”ê°€
                    </button>
                    <button class="btn-cancel" onclick="deleteCurrentLevel()" id="deleteLevelBtn" style="padding: 12px 25px; font-size: 1em;">
                        ğŸ—‘ï¸ í˜„ì¬ ë ˆë²¨ ì‚­ì œ
                    </button>
                </div>
            </div>

            <div class="editor-section">
                <h3>ğŸ¨ ìƒ‰ìƒ íŒ”ë ˆíŠ¸</h3>
                <div class="color-palette" id="colorPalette"></div>
                <button class="btn-save" onclick="addNewColor()">â• ìƒ‰ìƒ ì¶”ê°€</button>
            </div>

            <div class="editor-section">
                <h3>ğŸ§ª íŠœë¸Œ ì„¤ì •</h3>
                <div class="editor-grid">
                    <div class="input-group">
                        <label>íŠœë¸Œ ê°œìˆ˜</label>
                        <input type="number" id="numTubes" min="3" max="15" value="5" onchange="updateEditorTubes()">
                    </div>
                    <div class="input-group">
                        <label>ì„ íƒí•œ ìƒ‰ìƒ</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div id="selectedColorPreview" style="width: 40px; height: 40px; border-radius: 50%; border: 3px solid #333; background: #FF6B6B;"></div>
                            <span id="selectedColorName">ìƒ‰ìƒ 0</span>
                        </div>
                    </div>
                </div>
                <p style="color: #666; margin-bottom: 15px;">ğŸ’¡ íŠœë¸Œë¥¼ í´ë¦­í•˜ì—¬ ì„ íƒí•œ ìƒ‰ìƒì˜ ìƒˆë¥¼ ì¶”ê°€í•˜ì„¸ìš”. ìƒˆë¥¼ í´ë¦­í•˜ë©´ ì œê±°ë©ë‹ˆë‹¤.</p>
                <div class="tube-editor" id="tubeEditor"></div>
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal('editorModal')">
                    âŒ ì·¨ì†Œ
                </button>
                <button class="btn-save" onclick="saveLevel()">
                    ğŸ’¾ ì €ì¥
                </button>
                <button class="btn-cancel delete-world-btn" onclick="deleteCurrentWorld()" id="deleteWorldBtn" style="display: none;">
                    ğŸ—‘ï¸ ì›”ë“œ ì‚­ì œ
                </button>
            </div>
        </div>
    </div>

    <!-- ìƒˆ ì›”ë“œ ìƒì„± ëª¨ë‹¬ -->
    <div class="modal" id="newWorldModal">
        <div class="modal-content" style="max-width: 500px;">
            <h2>ğŸŒ ìƒˆ ì›”ë“œ ë§Œë“¤ê¸°</h2>
            <div class="input-group">
                <label>ì›”ë“œ ì´ë¦„</label>
                <input type="text" id="newWorldName" placeholder="ì˜ˆ: ë‚˜ë§Œì˜ ì›”ë“œ" maxlength="20">
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal('newWorldModal')">
                    âŒ ì·¨ì†Œ
                </button>
                <button class="btn-save" onclick="createNewWorld()">
                    âœ… ìƒì„±
                </button>
            </div>
        </div>
    </div>

    <script>
        // ê¸°ë³¸ ë ˆë²¨ë“¤
        const DEFAULT_LEVELS = [
            {tubes: [[0, 0, 1, 1], [2, 2, 0, 0], [1, 1, 2, 2], [], []]},
            {tubes: [[0, 1, 2, 0], [1, 0, 1, 2], [2, 2, 1, 0], [], []]},
            {tubes: [[0, 1, 2, 3], [1, 2, 3, 0], [2, 3, 0, 1], [3, 0, 1, 2], [], []]},
            {tubes: [[0, 1, 0, 2], [3, 3, 1, 2], [1, 2, 0, 3], [2, 1, 3, 0], [], []]},
            {tubes: [[0, 1, 2, 3], [4, 0, 1, 2], [3, 4, 0, 1], [2, 3, 4, 0], [1, 2, 3, 4], [], []]},
            {tubes: [[0, 1, 2, 0], [3, 4, 1, 3], [2, 4, 2, 1], [4, 0, 3, 1], [3, 4, 0, 2], [], []]},
            {tubes: [[0, 1, 2, 3], [4, 5, 0, 1], [2, 3, 4, 5], [0, 1, 2, 3], [4, 5, 0, 1], [2, 3, 4, 5], [], []]},
            {tubes: [[0, 1, 2, 0], [3, 4, 5, 1], [2, 3, 4, 5], [0, 1, 2, 3], [4, 5, 0, 1], [2, 3, 4, 5], [], []]},
            {tubes: [[0, 1, 2, 3], [4, 5, 6, 0], [1, 2, 3, 4], [5, 6, 0, 1], [2, 3, 4, 5], [6, 0, 1, 2], [3, 4, 5, 6], [], []]},
            {tubes: [[0, 1, 0, 2], [3, 4, 5, 6], [1, 2, 3, 4], [5, 6, 0, 1], [2, 3, 4, 5], [6, 0, 1, 2], [3, 4, 5, 6], [], []]},
            {tubes: [[0, 1, 2, 3], [4, 5, 6, 7], [0, 1, 2, 3], [4, 5, 6, 7], [0, 1, 2, 3], [4, 5, 6, 7], [0, 1, 2, 3], [4, 5, 6, 7], [], []]},
            {tubes: [[0, 1, 2, 0], [3, 4, 5, 6], [7, 1, 2, 3], [4, 5, 6, 7], [0, 1, 2, 3], [4, 5, 6, 7], [0, 1, 2, 3], [4, 5, 6, 7], [], []]},
            {tubes: [[0, 1, 2, 3], [4, 5, 6, 7], [8, 0, 1, 2], [3, 4, 5, 6], [7, 8, 0, 1], [2, 3, 4, 5], [6, 7, 8, 0], [1, 2, 3, 4], [5, 6, 7, 8], [], []]},
            {tubes: [[0, 1, 0, 2], [3, 4, 5, 6], [7, 8, 1, 2], [3, 4, 5, 6], [7, 8, 0, 1], [2, 3, 4, 5], [6, 7, 8, 0], [1, 2, 3, 4], [5, 6, 7, 8], [], []]},
            {tubes: [[0, 1, 2, 3], [4, 5, 6, 7], [8, 9, 0, 1], [2, 3, 4, 5], [6, 7, 8, 9], [0, 1, 2, 3], [4, 5, 6, 7], [8, 9, 0, 1], [2, 3, 4, 5], [6, 7, 8, 9], [], []]}
        ];

        const DEFAULT_COLORS = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', 
            '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2',
            '#F8B4B4', '#A2D9CE', '#FF9FF3', '#54A0FF'
        ];

        // ê²Œì„ ìƒíƒœ
        let worlds = [];
        let currentWorldIndex = 0;
        let currentLevel = 1;
        let tubes = [];
        let selectedTube = null;
        let moves = 0;
        let history = [];
        let initialState = [];
        let birdColors = [...DEFAULT_COLORS];
        let selectedColorIndex = 0;
        let hintCount = 3;
        let editorCurrentLevel = 1; // ì—ë””í„°ì—ì„œ í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë ˆë²¨

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¡œë“œ
        function loadData() {
            const saved = localStorage.getItem('birdSortWorlds');
            if (saved) {
                worlds = JSON.parse(saved);
            } else {
                worlds = [{
                    name: 'ê¸°ë³¸ ì›”ë“œ',
                    levels: DEFAULT_LEVELS,
                    colors: [...DEFAULT_COLORS],
                    isDefault: true
                }];
            }
        }

        // ë°ì´í„° ì €ì¥
        function saveData() {
            localStorage.setItem('birdSortWorlds', JSON.stringify(worlds));
        }

        // SVG ìƒˆ ìƒì„±
        function createBirdSVG(color) {
            return `data:image/svg+xml,${encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                    <ellipse cx="50" cy="60" rx="28" ry="32" fill="${color}" stroke="#333" stroke-width="2.5"/>
                    <circle cx="50" cy="32" r="20" fill="${color}" stroke="#333" stroke-width="2.5"/>
                    <circle cx="44" cy="28" r="5" fill="white" stroke="#333" stroke-width="1.5"/>
                    <circle cx="44" cy="28" r="2.5" fill="black"/>
                    <polygon points="62,32 74,30 62,28" fill="#FF8C00" stroke="#333" stroke-width="1.5"/>
                    <ellipse cx="32" cy="60" rx="18" ry="28" fill="${color}" opacity="0.85" stroke="#333" stroke-width="2"/>
                    <ellipse cx="22" cy="70" rx="14" ry="22" fill="${color}" opacity="0.75" stroke="#333" stroke-width="2" transform="rotate(-25 22 70)"/>
                    <line x1="44" y1="88" x2="40" y2="96" stroke="#FF6347" stroke-width="3" stroke-linecap="round"/>
                    <line x1="56" y1="88" x2="60" y2="96" stroke="#FF6347" stroke-width="3" stroke-linecap="round"/>
                    <line x1="40" y1="96" x2="35" y2="96" stroke="#FF6347" stroke-width="2.5" stroke-linecap="round"/>
                    <line x1="60" y1="96" x2="65" y2="96" stroke="#FF6347" stroke-width="2.5" stroke-linecap="round"/>
                </svg>
            `)}`;
        }

        // ì›”ë“œ ì„ íƒê¸° ì—…ë°ì´íŠ¸
        function updateWorldSelector() {
            const container = document.getElementById('worldSelector');
            container.innerHTML = '';

            worlds.forEach((world, index) => {
                const btn = document.createElement('button');
                btn.className = 'world-btn' + (index === currentWorldIndex ? ' active' : '');
                btn.innerHTML = `<span>ğŸŒ</span> ${world.name}`;
                btn.onclick = () => switchWorld(index);
                container.appendChild(btn);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'world-btn add-world';
            addBtn.innerHTML = '<span>â•</span> ìƒˆ ì›”ë“œ';
            addBtn.onclick = () => openModal('newWorldModal');
            container.appendChild(addBtn);
        }

        // ì›”ë“œ ì „í™˜
        function switchWorld(index) {
            currentWorldIndex = index;
            currentLevel = 1;
            birdColors = [...worlds[index].colors];
            updateWorldSelector();
            initLevel(1);
        }

        // ìƒˆ ì›”ë“œ ìƒì„±
        function createNewWorld() {
            const name = document.getElementById('newWorldName').value.trim();
            if (!name) {
                alert('ì›”ë“œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!');
                return;
            }

            worlds.push({
                name: name,
                levels: [{tubes: [[0, 0, 1, 1], [2, 2, 0, 0], [1, 1, 2, 2], [], []]}],
                colors: [...DEFAULT_COLORS],
                isDefault: false
            });

            saveData();
            currentWorldIndex = worlds.length - 1;
            currentLevel = 1;
            birdColors = [...worlds[currentWorldIndex].colors];
            closeModal('newWorldModal');
            updateWorldSelector();
            initLevel(1);
            openLevelEditor();
        }

        // í˜„ì¬ ì›”ë“œ ì‚­ì œ
        function deleteCurrentWorld() {
            if (worlds[currentWorldIndex].isDefault) {
                alert('ê¸°ë³¸ ì›”ë“œëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }

            if (!confirm('ì •ë§ ì´ ì›”ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            worlds.splice(currentWorldIndex, 1);
            saveData();
            currentWorldIndex = 0;
            currentLevel = 1;
            birdColors = [...worlds[0].colors];
            closeModal('editorModal');
            updateWorldSelector();
            initLevel(1);
        }

        // ë ˆë²¨ ì´ˆê¸°í™”
        function initLevel(level) {
            const currentWorld = worlds[currentWorldIndex];
            if (level > currentWorld.levels.length) {
                alert('ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ë ˆë²¨ì„ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤! ğŸ‰');
                level = 1;
            }
            if (level < 1) level = 1;

            currentLevel = level;
            moves = 0;
            selectedTube = null;
            history = [];
            hintCount = 3;

            tubes = JSON.parse(JSON.stringify(currentWorld.levels[level - 1].tubes));
            initialState = JSON.parse(JSON.stringify(tubes));

            updateDisplay();
            updateLevelNavButtons();
        }

        // ë ˆë²¨ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        function updateLevelNavButtons() {
            const prevBtn = document.getElementById('prevLevelBtn');
            const nextBtn = document.getElementById('nextLevelBtn');
            const currentWorld = worlds[currentWorldIndex];

            prevBtn.disabled = currentLevel <= 1;
            nextBtn.disabled = currentLevel >= currentWorld.levels.length;
        }

        // ì´ì „ ë ˆë²¨
        function previousLevel() {
            if (currentLevel > 1) {
                initLevel(currentLevel - 1);
            }
        }

        // ë‹¤ìŒ ë ˆë²¨
        function nextLevel() {
            closeModal('winModal');
            initLevel(currentLevel + 1);
        }

        // í™”ë©´ ì—…ë°ì´íŠ¸
        function updateDisplay(animateNewBird = false) {
            document.getElementById('level').textContent = currentLevel;
            document.getElementById('moves').textContent = moves;
            document.getElementById('undoBtn').disabled = history.length === 0;

            const container = document.getElementById('tubesContainer');
            container.innerHTML = '';

            tubes.forEach((tube, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'tube-wrapper';
                if (selectedTube === index) {
                    wrapper.classList.add('selected');
                }

                const tubeDiv = document.createElement('div');
                tubeDiv.className = 'tube';

                tube.forEach((birdIndex, birdPos) => {
                    const birdDiv = document.createElement('div');
                    birdDiv.className = 'bird-in-tube';
                    
                    // ë§¨ ìœ„ì˜ ìƒˆ(ë§ˆì§€ë§‰ ì¸ë±ìŠ¤)ëŠ” í•­ìƒ ì¦‰ì‹œ í‘œì‹œ
                    // ìƒˆë¡œ ì´ë™ëœ ìƒˆë§Œ ì• ë‹ˆë©”ì´ì…˜ ì ìš©
                    if (animateNewBird && birdPos === tube.length - 1) {
                        birdDiv.classList.add('pop-in');
                    }
                    
                    birdDiv.dataset.tubeIndex = index;
                    birdDiv.dataset.birdPos = birdPos;

                    const img = document.createElement('img');
                    img.src = createBirdSVG(birdColors[birdIndex]);
                    img.className = 'bird-svg';
                    img.alt = 'bird';

                    birdDiv.appendChild(img);
                    tubeDiv.appendChild(birdDiv);
                });

                const branch = document.createElement('div');
                branch.className = 'branch-base';

                wrapper.appendChild(tubeDiv);
                wrapper.appendChild(branch);
                wrapper.onclick = () => selectTube(index);
                container.appendChild(wrapper);
            });

            checkWin();
        }

        // íŠœë¸Œ ì„ íƒ
        function selectTube(index) {
            const statusMsg = document.getElementById('statusMsg');

            if (selectedTube === null) {
                if (tubes[index].length > 0) {
                    selectedTube = index;
                    // ì„ íƒ ì‹œ ì „ì²´ ë‹¤ì‹œ ê·¸ë¦¬ì§€ ì•Šê³  ìŠ¤íƒ€ì¼ë§Œ ë³€ê²½
                    document.querySelectorAll('.tube-wrapper').forEach((wrapper, i) => {
                        if (i === index) {
                            wrapper.classList.add('selected');
                        } else {
                            wrapper.classList.remove('selected');
                        }
                    });
                    statusMsg.textContent = 'âœ¨ ì´ë™í•  íŠœë¸Œë¥¼ ì„ íƒí•˜ì„¸ìš”';
                }
            } else {
                if (selectedTube === index) {
                    selectedTube = null;
                    statusMsg.textContent = '';
                    // ì„ íƒ í•´ì œ ì‹œì—ë„ ì „ì²´ ë‹¤ì‹œ ê·¸ë¦¬ì§€ ì•Šê³  ìŠ¤íƒ€ì¼ë§Œ ì œê±°
                    document.querySelectorAll('.tube-wrapper').forEach(wrapper => {
                        wrapper.classList.remove('selected');
                    });
                } else {
                    if (canMove(selectedTube, index)) {
                        // ì´ë™ ì• ë‹ˆë©”ì´ì…˜
                        const fromTubeEl = document.querySelectorAll('.tube-wrapper')[selectedTube];
                        const topBird = fromTubeEl.querySelector('.bird-in-tube:last-child');
                        if (topBird) {
                            topBird.classList.add('moving');
                        }

                        setTimeout(() => {
                            history.push(JSON.parse(JSON.stringify(tubes)));
                            const bird = tubes[selectedTube].pop();
                            tubes[index].push(bird);
                            moves++;
                            
                            const fromIndex = selectedTube;
                            const toIndex = index;
                            selectedTube = null;
                            
                            statusMsg.innerHTML = '<span style="color: #4CAF50;">âœ… ì™„ë£Œ!</span>';
                            setTimeout(() => {
                                statusMsg.textContent = '';
                            }, 1000);
                            
                            // ì „ì²´ ë‹¤ì‹œ ê·¸ë¦¬ì§€ ì•Šê³  í•´ë‹¹ íŠœë¸Œë§Œ ì—…ë°ì´íŠ¸
                            updateSingleTube(fromIndex);
                            updateSingleTube(toIndex, true);
                            
                            // ì´ë™ íšŸìˆ˜ë§Œ ì—…ë°ì´íŠ¸
                            document.getElementById('moves').textContent = moves;
                            document.getElementById('undoBtn').disabled = history.length === 0;
                            
                            checkWin();
                        }, 300);
                    } else {
                        statusMsg.innerHTML = '<span style="color: #f44336;">âŒ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!</span>';
                        setTimeout(() => {
                            if (selectedTube !== null) {
                                statusMsg.textContent = 'âœ¨ ì´ë™í•  íŠœë¸Œë¥¼ ì„ íƒí•˜ì„¸ìš”';
                            } else {
                                statusMsg.textContent = '';
                            }
                        }, 1500);
                    }
                }
            }
        }

        // ë‹¨ì¼ íŠœë¸Œë§Œ ì—…ë°ì´íŠ¸
        function updateSingleTube(tubeIndex, animateNew = false) {
            const wrappers = document.querySelectorAll('.tube-wrapper');
            const wrapper = wrappers[tubeIndex];
            const tubeDiv = wrapper.querySelector('.tube');
            
            // íŠœë¸Œ ë‚´ìš© ì§€ìš°ê¸°
            tubeDiv.innerHTML = '';
            
            // ìƒˆë“¤ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            tubes[tubeIndex].forEach((birdIndex, birdPos) => {
                const birdDiv = document.createElement('div');
                birdDiv.className = 'bird-in-tube';
                
                // ìƒˆë¡œ ì¶”ê°€ëœ ìƒˆ(ë§¨ ìœ„)ë§Œ ì• ë‹ˆë©”ì´ì…˜
                if (animateNew && birdPos === tubes[tubeIndex].length - 1) {
                    birdDiv.classList.add('pop-in');
                }
                
                birdDiv.dataset.tubeIndex = tubeIndex;
                birdDiv.dataset.birdPos = birdPos;

                const img = document.createElement('img');
                img.src = createBirdSVG(birdColors[birdIndex]);
                img.className = 'bird-svg';
                img.alt = 'bird';

                birdDiv.appendChild(img);
                tubeDiv.appendChild(birdDiv);
            });
        }

        // ì´ë™ ê°€ëŠ¥ ì—¬ë¶€
        function canMove(from, to) {
            if (tubes[from].length === 0) return false;
            if (tubes[to].length >= 4) return false;
            if (tubes[to].length === 0) return true;

            const fromBird = tubes[from][tubes[from].length - 1];
            const toBird = tubes[to][tubes[to].length - 1];
            return fromBird === toBird;
        }

        // íŠœë¸Œ ì •ë ¬ í™•ì¸
        function isTubeSorted(tube) {
            if (tube.length === 0) return true;
            if (tube.length !== 4) return false;
            const firstBird = tube[0];
            return tube.every(bird => bird === firstBird);
        }

        // ìŠ¹ë¦¬ í™•ì¸
        function checkWin() {
            const usedColors = new Set(tubes.flat());
            const numColors = usedColors.size;
            const sortedTubes = tubes.filter(tube => isTubeSorted(tube) && tube.length > 0).length;

            if (sortedTubes === numColors && numColors > 0) {
                setTimeout(() => {
                    document.getElementById('finalMoves').textContent = moves;
                    openModal('winModal');
                }, 700);
            }
        }

        // ë˜ëŒë¦¬ê¸°
        function undoMove() {
            if (history.length > 0) {
                tubes = history.pop();
                moves--;
                selectedTube = null;
                document.getElementById('statusMsg').textContent = '';
                updateDisplay();
            }
        }

        // ë‹¤ì‹œ ì‹œì‘
        function restartLevel() {
            tubes = JSON.parse(JSON.stringify(initialState));
            moves = 0;
            selectedTube = null;
            history = [];
            hintCount = 3;
            document.getElementById('statusMsg').textContent = '';
            updateDisplay();
        }

        // íŒíŠ¸ í‘œì‹œ
        function showHint() {
            if (hintCount <= 0) {
                alert('íŒíŠ¸ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤!');
                return;
            }

            const validMoves = findValidMoves();
            if (validMoves.length === 0) {
                alert('ê°€ëŠ¥í•œ ì´ë™ì´ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }

            // ì ìˆ˜ê°€ ë†’ì€ ì´ë™ ì°¾ê¸°
            let bestMove = validMoves[0];
            let bestScore = -1;

            validMoves.forEach(move => {
                let score = 0;
                const fromBird = tubes[move.from][tubes[move.from].length - 1];
                
                // ê°™ì€ ìƒ‰ì´ ë§ì´ ëª¨ì´ëŠ” ê³³ìœ¼ë¡œ ì´ë™í•˜ë©´ ì ìˆ˜ ë†’ìŒ
                if (tubes[move.to].length > 0) {
                    const toBird = tubes[move.to][tubes[move.to].length - 1];
                    if (fromBird === toBird) {
                        score += tubes[move.to].length * 10;
                    }
                }

                // íŠœë¸Œê°€ ê±°ì˜ ì™„ì„±ë˜ë©´ ì ìˆ˜ ë†’ìŒ
                if (tubes[move.to].length === 3) score += 50;

                if (score > bestScore) {
                    bestScore = score;
                    bestMove = move;
                }
            });

            hintCount--;
            const statusMsg = document.getElementById('statusMsg');
            statusMsg.innerHTML = `<span style="color: #17a2b8;">ğŸ’¡ íŒíŠ¸: ${bestMove.from + 1}ë²ˆ â†’ ${bestMove.to + 1}ë²ˆ íŠœë¸Œ (ë‚¨ì€ íŒíŠ¸: ${hintCount})</span>`;
            setTimeout(() => {
                statusMsg.textContent = '';
            }, 3000);
        }

        // ìœ íš¨í•œ ì´ë™ ì°¾ê¸°
        function findValidMoves() {
            const moves = [];
            for (let from = 0; from < tubes.length; from++) {
                if (tubes[from].length === 0) continue;
                for (let to = 0; to < tubes.length; to++) {
                    if (from === to) continue;
                    if (canMove(from, to)) {
                        moves.push({ from, to });
                    }
                }
            }
            return moves;
        }

        // ë ˆë²¨ ì—ë””í„° ì—´ê¸°
        function openLevelEditor() {
            const currentWorld = worlds[currentWorldIndex];
            editorCurrentLevel = currentLevel;
            
            birdColors = [...currentWorld.colors];
            selectedColorIndex = 0;
            
            loadEditorLevel();
            openModal('editorModal');
        }

        // ì—ë””í„°ì—ì„œ ë ˆë²¨ ë¡œë“œ
        function loadEditorLevel() {
            const currentWorld = worlds[currentWorldIndex];
            
            document.getElementById('editorWorldInfo').innerHTML = `
                <h3>${currentWorld.name}</h3>
            `;

            document.getElementById('editorLevelNum').textContent = editorCurrentLevel;
            document.getElementById('editorTotalLevels').textContent = currentWorld.levels.length;

            if (!currentWorld.isDefault) {
                document.getElementById('deleteWorldBtn').style.display = 'block';
            } else {
                document.getElementById('deleteWorldBtn').style.display = 'none';
            }

            // ë ˆë²¨ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€
            if (currentWorld.levels.length > 1) {
                document.getElementById('deleteLevelBtn').style.display = 'block';
            } else {
                document.getElementById('deleteLevelBtn').style.display = 'none';
            }

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ
            document.getElementById('editorPrevBtn').disabled = editorCurrentLevel <= 1;
            document.getElementById('editorNextBtn').disabled = editorCurrentLevel >= currentWorld.levels.length;

            updateColorPalette();
            
            tubes = JSON.parse(JSON.stringify(currentWorld.levels[editorCurrentLevel - 1].tubes));
            document.getElementById('numTubes').value = tubes.length;
            updateEditorTubes();
        }

        // ì—ë””í„°ì—ì„œ ì´ì „ ë ˆë²¨
        function editorPreviousLevel() {
            if (editorCurrentLevel > 1) {
                editorCurrentLevel--;
                loadEditorLevel();
            }
        }

        // ì—ë””í„°ì—ì„œ ë‹¤ìŒ ë ˆë²¨
        function editorNextLevel() {
            const currentWorld = worlds[currentWorldIndex];
            if (editorCurrentLevel < currentWorld.levels.length) {
                editorCurrentLevel++;
                loadEditorLevel();
            }
        }

        // ìƒˆ ë ˆë²¨ ì¶”ê°€
        function addNewLevel() {
            const currentWorld = worlds[currentWorldIndex];
            
            // ê¸°ë³¸ ë ˆë²¨ í…œí”Œë¦¿ (3ê°€ì§€ ìƒ‰, 5ê°œ íŠœë¸Œ)
            const newLevel = {
                tubes: [
                    [0, 0, 1, 1],
                    [2, 2, 0, 0],
                    [1, 1, 2, 2],
                    [],
                    []
                ]
            };

            currentWorld.levels.push(newLevel);
            saveData();
            
            editorCurrentLevel = currentWorld.levels.length;
            loadEditorLevel();
            
            const statusMsg = document.createElement('div');
            statusMsg.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #4CAF50; color: white; padding: 15px 30px; border-radius: 10px; font-weight: bold; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.3);';
            statusMsg.textContent = 'âœ… ìƒˆ ë ˆë²¨ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!';
            document.body.appendChild(statusMsg);
            setTimeout(() => statusMsg.remove(), 2000);
        }

        // í˜„ì¬ ë ˆë²¨ ì‚­ì œ
        function deleteCurrentLevel() {
            const currentWorld = worlds[currentWorldIndex];
            
            if (currentWorld.levels.length <= 1) {
                alert('ìµœì†Œ 1ê°œì˜ ë ˆë²¨ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }

            if (!confirm(`ë ˆë²¨ ${editorCurrentLevel}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            currentWorld.levels.splice(editorCurrentLevel - 1, 1);
            saveData();

            // ì‚­ì œ í›„ ë ˆë²¨ ìœ„ì¹˜ ì¡°ì •
            if (editorCurrentLevel > currentWorld.levels.length) {
                editorCurrentLevel = currentWorld.levels.length;
            }

            // í˜„ì¬ í”Œë ˆì´ ì¤‘ì¸ ë ˆë²¨ë„ ì¡°ì •
            if (currentLevel > currentWorld.levels.length) {
                currentLevel = currentWorld.levels.length;
            }

            loadEditorLevel();
            
            const statusMsg = document.createElement('div');
            statusMsg.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #f44336; color: white; padding: 15px 30px; border-radius: 10px; font-weight: bold; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.3);';
            statusMsg.textContent = 'ğŸ—‘ï¸ ë ˆë²¨ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!';
            document.body.appendChild(statusMsg);
            setTimeout(() => statusMsg.remove(), 2000);
        }

        // ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì—…ë°ì´íŠ¸
        function updateColorPalette() {
            const container = document.getElementById('colorPalette');
            container.innerHTML = '';

            birdColors.forEach((color, index) => {
                const item = document.createElement('div');
                item.className = 'color-item';
                if (index === selectedColorIndex) {
                    item.style.borderColor = '#667eea';
                    item.style.background = '#e8ecff';
                }

                const preview = document.createElement('div');
                preview.className = 'color-preview';
                preview.style.background = color;
                preview.onclick = () => {
                    selectedColorIndex = index;
                    updateColorPalette();
                    updateSelectedColorDisplay();
                };

                const input = document.createElement('input');
                input.type = 'color';
                input.value = color;
                input.onchange = (e) => {
                    birdColors[index] = e.target.value;
                    updateColorPalette();
                    updateSelectedColorDisplay();
                };

                const label = document.createElement('span');
                label.textContent = `ìƒ‰ìƒ ${index}`;
                label.style.fontWeight = 'bold';

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'ğŸ—‘ï¸';
                deleteBtn.className = 'btn-cancel';
                deleteBtn.style.padding = '5px 10px';
                deleteBtn.style.fontSize = '0.8em';
                deleteBtn.onclick = () => {
                    if (birdColors.length <= 3) {
                        alert('ìµœì†Œ 3ê°œì˜ ìƒ‰ìƒì´ í•„ìš”í•©ë‹ˆë‹¤!');
                        return;
                    }
                    birdColors.splice(index, 1);
                    if (selectedColorIndex >= birdColors.length) {
                        selectedColorIndex = birdColors.length - 1;
                    }
                    updateColorPalette();
                    updateSelectedColorDisplay();
                    updateEditorTubes();
                };

                item.appendChild(preview);
                item.appendChild(input);
                item.appendChild(label);
                item.appendChild(deleteBtn);
                container.appendChild(item);
            });

            updateSelectedColorDisplay();
        }

        // ì„ íƒëœ ìƒ‰ìƒ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateSelectedColorDisplay() {
            document.getElementById('selectedColorPreview').style.background = birdColors[selectedColorIndex];
            document.getElementById('selectedColorName').textContent = `ìƒ‰ìƒ ${selectedColorIndex}`;
        }

        // ìƒˆ ìƒ‰ìƒ ì¶”ê°€
        function addNewColor() {
            if (birdColors.length >= 12) {
                alert('ìµœëŒ€ 12ê°œì˜ ìƒ‰ìƒê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
                return;
            }
            const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            birdColors.push(randomColor);
            selectedColorIndex = birdColors.length - 1;
            updateColorPalette();
        }

        // ì—ë””í„° íŠœë¸Œ ì—…ë°ì´íŠ¸
        function updateEditorTubes() {
            const numTubes = parseInt(document.getElementById('numTubes').value);
            const container = document.getElementById('tubeEditor');
            container.innerHTML = '';

            // í˜„ì¬ íŠœë¸Œ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
            const currentTubes = tubes.length > 0 ? JSON.parse(JSON.stringify(tubes)) : [];

            // íŠœë¸Œ ìˆ˜ì— ë§ê²Œ ì¡°ì •
            while (currentTubes.length < numTubes) {
                currentTubes.push([]);
            }
            while (currentTubes.length > numTubes) {
                currentTubes.pop();
            }

            currentTubes.forEach((tube, tubeIndex) => {
                const tubeContainer = document.createElement('div');
                
                const tubeDiv = document.createElement('div');
                tubeDiv.className = 'editor-tube';

                for (let i = 0; i < 4; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'editor-bird-slot';

                    if (tube[i] !== undefined) {
                        const img = document.createElement('img');
                        img.src = createBirdSVG(birdColors[tube[i]]);
                        slot.appendChild(img);

                        // ìƒ‰ìƒ íˆ´íŒ ì¶”ê°€
                        const tooltip = document.createElement('div');
                        tooltip.className = 'color-tooltip';
                        tooltip.textContent = `ìƒ‰ìƒ ${tube[i]}`;
                        slot.appendChild(tooltip);

                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-btn';
                        removeBtn.textContent = 'âœ•';
                        removeBtn.onclick = (e) => {
                            e.stopPropagation();
                            tube[i] = undefined;
                            tube.splice(i, 1);
                            updateEditorTubes();
                        };
                        slot.appendChild(removeBtn);
                    }

                    slot.onclick = () => {
                        if (tube.length < 4 && tube[i] === undefined) {
                            tube.push(selectedColorIndex);
                            updateEditorTubes();
                        }
                    };

                    tubeDiv.appendChild(slot);
                }

                const controls = document.createElement('div');
                controls.className = 'tube-controls';

                const clearBtn = document.createElement('button');
                clearBtn.textContent = 'ğŸ—‘ï¸ ë¹„ìš°ê¸°';
                clearBtn.className = 'btn-cancel';
                clearBtn.onclick = () => {
                    currentTubes[tubeIndex] = [];
                    updateEditorTubes();
                };

                controls.appendChild(clearBtn);
                tubeContainer.appendChild(tubeDiv);
                tubeContainer.appendChild(controls);
                container.appendChild(tubeContainer);
            });

            tubes = currentTubes;
        }

        // ë ˆë²¨ ì €ì¥
        function saveLevel() {
            // ìœ íš¨ì„± ê²€ì‚¬
            const usedColors = new Set(tubes.flat());
            const emptyTubes = tubes.filter(t => t.length === 0).length;

            if (usedColors.size === 0) {
                alert('ìµœì†Œ 1ê°œì˜ ìƒˆë¥¼ ë°°ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤!');
                return;
            }

            if (emptyTubes < 2) {
                alert('ìµœì†Œ 2ê°œì˜ ë¹ˆ íŠœë¸Œê°€ í•„ìš”í•©ë‹ˆë‹¤!');
                return;
            }

            // ê° ìƒ‰ìƒì´ 4ê°œì”© ìˆëŠ”ì§€ í™•ì¸
            const colorCounts = {};
            tubes.flat().forEach(color => {
                colorCounts[color] = (colorCounts[color] || 0) + 1;
            });

            for (let color in colorCounts) {
                if (colorCounts[color] !== 4) {
                    alert(`ìƒ‰ìƒ ${color}ëŠ” ì •í™•íˆ 4ë§ˆë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤! (í˜„ì¬: ${colorCounts[color]}ë§ˆë¦¬)`);
                    return;
                }
            }

            const currentWorld = worlds[currentWorldIndex];
            currentWorld.levels[editorCurrentLevel - 1] = {
                tubes: JSON.parse(JSON.stringify(tubes))
            };
            currentWorld.colors = [...birdColors];

            saveData();
            closeModal('editorModal');
            
            // í˜„ì¬ í”Œë ˆì´ ì¤‘ì¸ ë ˆë²¨ì´ ìˆ˜ì •ë˜ì—ˆë‹¤ë©´ ë¦¬ë¡œë“œ
            if (editorCurrentLevel === currentLevel) {
                initLevel(currentLevel);
            }
            
            const statusMsg = document.createElement('div');
            statusMsg.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #4CAF50; color: white; padding: 15px 30px; border-radius: 10px; font-weight: bold; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.3);';
            statusMsg.textContent = 'âœ… ë ˆë²¨ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
            document.body.appendChild(statusMsg);
            setTimeout(() => statusMsg.remove(), 2000);
        }

        // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        function openModal(id) {
            document.getElementById(id).classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
            if (id === 'newWorldModal') {
                document.getElementById('newWorldName').value = '';
            }
        }

        // ê²Œì„ ì‹œì‘
        loadData();
        updateWorldSelector();
        initLevel(1);
    </script>
</body>
</html>
